<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.18/c3.css">
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.18/c3.js"></script>
    <script>
        //firestore的api
const firebaseConfig = {
    apiKey: "AIzaSyBJCR_Vejg4Ojc3Yf9Lr5g974VPT6wAzQ4",
    authDomain: "product-7e07d.firebaseapp.com",
    databaseURL: "https://product-7e07d.firebaseio.com",
    projectId: "product-7e07d",
    storageBucket: "product-7e07d.appspot.com",
    messagingSenderId: "242223861817",
    appId: "1:242223861817:web:2ddab536fdf617cd787de8",
    measurementId: "G-QL1MJ04YTL"
  };

firebase.initializeApp(firebaseConfig);

//設定讀取firestore的權限
  var email = "mavis@gmail.com";
  var password = "123456";
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then((user) => {
    })
    .catch((error) => {
      var errorCode = error.code;
      var errorMessage = error.message;
    });

const db=firebase.firestore();

//根據使用者的不同去更改要選取的文件（文件id為使用者id）
let user="MqBLA3H8y9NcvwcU3zbmbrhbLZB2";
const docRef =  db.collection("fullrecord").doc(user).collection("record");

//--------------STEP1:主程式--------------
//選取使用者的record集合下的所有文件（隨機id），讀取裡面的內容
docRef.get().then(function(item) {
let collect=[];
let count=[];
  
//pie chart
item.forEach(function(doc) {
       const record=doc.data();
  
       //新增分類進陣列（collect）
       checkcount(record);
       datacollect(collect,count);
    });
  
  //-------STEP2:計算使用者再每個分類的金額-----
function checkcount(record){
  //如果陣列裡面含有要新增的分類 =>對應的count陣列+1
  if (collect.includes(record["classification"])){
    count[collect.indexOf(record["classification"])]+=record["price"];
  }
  
  //如果陣列裡面沒有要新增的分類 =>新增分類到collect陣列，對應的count陣列+1
  else{
    collect.push(record["classification"]);
    count.push(0);
    count[collect.indexOf(record["classification"])]+=1;
  }
  
 };
 //-------STEP3:將資料轉換成c3.js的格式-----
function datacollect(collect,count){
  let data=[];
  let number=0;
  collect.forEach(function(collect_item){
      data.push([collect_item,count[number]]);
      number+=1;    
  });

  let chart = c3.generate({
    data: {
        columns:data,
        type : 'pie'
    }
});
}

 
 //area chart
//allmonth陣列：1到31號的日期陣列
let allmonth=['x'];
for (let i = 1; i < 32; i++) {
  allmonth.push(i);
}
  
//count陣列：含有三十天初始值為0的金額（ES6新的寫法fill()太好用囉！）
let count2=Array(30).fill(0);
count2.unshift("12月");
item.forEach(function(doc) {
       const record=doc.data();
       //新增分類進陣列（collect）
       checkcount2(record);
       datacollect2(allmonth,count2);
    });
  
  //-------STEP2:計算使用者每天的金額到count陣列裡-----
function checkcount2(record){
  if(record["month"]=="12"&&record["year"]=="2020"){
      count2[parseInt(record["date"])]+= record["price"];
  }
 };
function datacollect2(allmonth,count2){
    let chart2 = c3.generate({
    data: {
        x:'x',
        columns: [allmonth,count2],
        types: {
            '12月': 'area',
        }
    },
      bindto: '#chart2'
});
  }
});

    </script>
    <style>
      #chart{
      margin-bottom: 30px;
    }
      #chart2{
      margin-top: 30px;
    }


    </style>

</head>
<body>

  <div id="chart"></div>
  <hr>
  <div id="chart2"></div>
</body>
</html>
